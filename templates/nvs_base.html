{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>New Variorum Shakespeare</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="shortcut icon" type="image/png" href="{% static 'img/favicon.ico' %}"/>
  <link rel="stylesheet" href="{% static 'css/nvs.css' %}">
  <!-- Plausible.io (for site analytics) -->
  <script defer data-domain="newvariorumshakespeare.org" src="https://plausible.io/js/plausible.js"></script>

  <style>
    @font-face {
        font-family: "Halyard Text";
        src: url("/static/proprietary/font/HalyardText-Reg.woff2") format('woff2'), url("/static/proprietary/font/HalyardText-Reg.woff") format('woff');
    }

    .nvs_base--main { margin-top: 40px; }
    @media ( min-width: 992px ) {
      .nvs_base--main { margin-top: 23px; }
    }
  </style>
  {% block headrefs %}
  {% endblock %}
</head>
<body class="{% block body_class %}{% endblock %}">

{% include 'blocks/organisms/small-header.html' %}
{% include 'blocks/organisms/large-header.html' %}

<main class="nvs_base--main">
  {% block main %}
  {% endblock %}

  <!-- Here could be some javascript libraries referenced by every page -->

  <!-- Here is a block for child pages to have their own specific javascript libraries: -->
  {% block js %}
  {% endblock %}
</main>
{% include 'blocks/organisms/footer.html' %}
</body>

<script type="text/javascript">
  let scrollSpy = null
  let navLinkMap = {}
  let currentActiveNavLink = null

  function navInit() {
    let holders = document.querySelectorAll('.navigation--holder');
    holders.forEach(holder => {

      let dropDowns = holder.querySelectorAll('.navigation--dropdown');
      dropDowns.forEach(dropDown => {
        let button = dropDown.firstElementChild;
        button.addEventListener('click', () => {
          if (dropDown.classList.contains('active')) {
            dropDown.classList.remove('active');
          } else {
            let previouslyActive;
            if (dropDown.classList.contains('nested')) {
              previouslyActive = holder.querySelector('.navigation--dropdown.active.nested');
            } else {
              previouslyActive = holder.querySelector('.navigation--dropdown.active.parent');
            }
            if (previouslyActive) {
              previouslyActive.classList.remove('active');
            }
            dropDown.classList.add('active');
          }
        });
      })

    })
  }

  function anchorInit() {
    let holder = document.querySelector('.anchor-links--holder');
    if(holder) {
      // Set up toggle button
      let toggleButton = holder.querySelector('.anchor-links--holder .anchor-links--toggle');
      if(toggleButton) {
        toggleButton.addEventListener('click', () => {
          holder.classList.toggle('active');
        });
      }

      // Close when link is clicked.
      let inner = holder.querySelector('.anchor-links--inner');
      if (inner) {
        inner.addEventListener('click', () => {
          holder.classList.remove('active');
        });
      }

      // Set up active states if content is in screen
      let anchorLinks = document.querySelectorAll('.anchor-links--holder .anchor-link a')
      if (anchorLinks.length) {
        scrollSpy = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    if (entry.target.id in navLinkMap && entry.target.id !== currentActiveNavLink) {
                        if (currentActiveNavLink !== null) navLinkMap[currentActiveNavLink].classList.remove('active')
                        navLinkMap[entry.target.id].classList.add('active')
                        currentActiveNavLink = entry.target.id
                    }
                }
            })
        })

        anchorLinks.forEach(link => {
            if (link.getAttribute('href').startsWith('#')) {
                let linkTargetId = link.getAttribute('href').replace('#', '')
                let linkTarget = document.getElementById(linkTargetId)

                if (linkTarget) {
                    scrollSpy.observe(linkTarget)
                    navLinkMap[linkTargetId] = link.parentNode
                }
            }
        })
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    navInit();
    setTimeout(() => anchorInit(), 1000);
  })
</script>

</html>