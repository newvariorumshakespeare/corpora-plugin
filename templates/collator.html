{% extends 'base.html' %}
{% load static %}
{% load extras %}

{% block css %}
    <link href="{% static 'css/filepond.css' %}" rel="stylesheet">
    <style>
        @font-face {
            font-family: "Baskerville";
            src: url("/static/proprietary/font/Baskerville10Pro.woff") format('woff');
        }

        @font-face {
            font-family: "Baskerville";
            src: url("/static/proprietary/font/Baskerville10Pro-Bold.woff") format('woff');
            font-weight: bold;
        }

        @font-face {
            font-family: "Baskerville";
            src: url("/static/proprietary/font/Baskerville10Pro-Italic.woff") format('woff');
            font-style: italic;
        }

        @font-face {
            font-family: "Baskerville";
            src: url("/static/proprietary/font/Baskerville10Pro-BoldItalic.woff") format('woff');
            font-weight: bold;
            font-style: italic;
        }

        .tln-box { width: 100px; }

        .grid-col { width: 500px!important; height: 62px; }

        #collation-grid-container {
            max-width: 100vw;
            overflow-x: scroll;
            max-height: 100vh;
            overflow-y: scroll;
            padding-bottom: 100vh;
        }

        #collation-grid thead {
          position: sticky;
          top: 0;
          z-index: 2;
        }

        /* Sticky first column in each row */
        #collation-grid thead th:first-child, #collation-grid #collation-grid-body th {
          position: sticky;
          left: 0;
          z-index: 1;
        }

        #collation-grid th {
            color: #2D2D2D;
            background-color: rgb(249, 239, 228)!important;
            text-align: center;
            vertical-align: middle;
        }
        #collation-grid th.copy-text {
            color: #2D2D2D;
            font-weight: normal;
            text-align: left;
            box-shadow: 0 4px 2px -2px rgba(0, 0, 0, 0.1)!important;
        }
        #collation-grid th.tln-header { background-color: #6c9ecc!important; color: #FFFFFF; }

        #collation-grid td { border-bottom: solid 1px #6c9ecc!important; border-right: solid 1px #6c9ecc; }
        #collation-grid td.editing { background-color: rgba(249, 240, 175, .52); }
        #collation-grid thead th { border-bottom: none!important; }

        #collation-grid th.grid-left-header {
            box-shadow: 4px 0 2px -2px rgba(0, 0, 0, 0.1)!important;
            z-index: 10;
        }

        /* Top-left cell needs higher z-index to stay above both */
        .grid-row:first-child .grid-col:first-child {
          z-index: 3;
        }

        span.play-line {
            white-space: nowrap;
            font-family: 'Baskerville', serif;
            font-variant-numeric: oldstyle-nums;
            font-size: 1.125rem;
        }

        .difference {
            color: #FFFFFF;
            padding-left: 3px;
            padding-right: 3px;
        }
        .difference.selected {
            outline: 3px solid deeppink;
            outline-offset: 2px;
            border-radius: 50%;
        }
        .difference.replace {
            background-color: #e9702b;
        }
        .difference.delete {
            background-color: #6B0F1A;
            width: 2px;
            padding: 0!important;
            position: relative;
            display: inline-block; /* Needed for width to work */
            height: 20px; /* Adjust to your desired height */
        }
        .difference.delete::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 5px; /* Thickness of the line */
            background-color: #6B0F1A; /* Inherits text color, or use specific color */
            bottom: -8px; /* Position at bottom */
            left: 50%;
            transform: translateX(-50%); /* Center horizontally */
        }
        .difference.omission {
            background-color: #6B0F1A;
            display: inline-block;
            width: 100%;
        }
        .difference.insert {
            background-color: #008148;
        }


        #control-panel {
            position: fixed;
            bottom: calc(-180px + 43px);
            left: 50%;
            transform: translateX(-50%); /* Center it horizontally */
            width: 70vw;
            height: 180px;
            z-index: 20; /* Higher than the sticky headers */
            background-color: rgb(249, 239, 228);
            transition: bottom 0.3s ease-in-out; /* Smooth animation */
        }
        #control-panel.expanded { bottom: 0; }
        .control-panel-button {
            background-color: #F2F2F2;
            color: #2a69a1;
        }
        .control-panel-input {
            border: 1px solid #F2F2F2;
        }
    </style>
{% endblock %}

{% block modals %}


{% endblock %}

{% block main %}
    <div class="container-fluid">


        <!-- COLLATION GRID -->
        <div id="collation-grid-container">
            <table id="collation-grid" class="table table-borderless">
                <thead>
                    <tr id="collation-grid-header">
                        <th scope="col" id="collation-grid-leftmost" class="grid-left-header tln-header text-end">TLN</th>
                        <!-- Populated by JS -->
                    </tr>
                    <tr id="collation-grid-copy-text-row" class="grid-row">
                        <th scope="row" id="collation-grid-topmost" class="grid-left-header text-end">Copy Text</th>
                    </tr>
                </thead>
                <tbody id="collation-grid-body">

                </tbody>

                <!-- Populated by JS -->
            </table>

            <div id="control-panel">
                <form id="cp-edit-line-form" method="post">
                    {% csrf_token %}
                    <input type="hidden" id="cp-edit-collation-line-siglum" name="edit-collation-line-siglum" value="" />
                    <input type="hidden" id="cp-edit-collation-line-tln" name="edit-collation-line-tln" value="" />
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script src="{% static 'js/filepond.js' %}"></script>
    <script src="{% static 'js/ace/ace.js' %}"></script>
    <script src="{% static 'js/utilities.js' %}"></script>
    <script src="{% static 'js/collator/add-witness.js' %}"></script>
    <script src="{% static 'js/collator/import-copy-text.js' %}"></script>
    <script src="{% static 'js/collator/add-lines.js' %}"></script>
    <script src="{% static 'js/collator/line-collator.js' %}"></script>
    <script src="{% static 'js/collator/control-panel.js' %}"></script>
    <script src="{% static 'js/collator/tei-generator.js' %}"></script>
    <script type="application/javascript">
        let linesImporter = null
        let copyTextImporter = null
        let witnessImporter = null
        let lineCollator = null
        let controlPanel = null
        let teiGenerator = null

        let editedTLN = {% if edited_tln %}'{{ edited_tln }}'{% else %}null{% endif %}
        let editedSiglum = {% if edited_siglum %}'{{ edited_siglum }}'{% else %}null{% endif %}

        const queryString = window.location.search
        const urlParams = new URLSearchParams(queryString)

        let lineHeight = 62
        let lineWidth = 500
        let startingTLN = null

        $(document).ready(function() {
            window.nvs = {
                corpora: corpora,
                corporaHost: '{{ corpora_host }}',
                corpusID: '{{ corpus_id }}',
                corpus: null,
                play: '{{ play_prefix }}',
                playID: '{{ play_id }}',
                witnesses: {},
                orderedSigla: [],
                copyTextEstablished: false,
                tlns: [],
                visibleTLNs: [],
                allCells: new Set(),
                diffedCells: new Set(),
                maxLines: 50,
                lines: {},
            }
            window.nvs.endpoints = {
                line: `${window.nvs.corporaHost}/api/corpus/${window.nvs.corpusID}/PlayLine/`,
                lineRange: {% if site_request %}`${window.location.protocol}//${window.location.host}/lines/${window.nvs.play}/`{% else %}`/api/corpus/${window.nvs.corpusID}/nvs-lines/${window.nvs.play}/`{% endif %},
                note: `${window.nvs.corporaHost}/api/corpus/${window.nvs.corpusID}/TextualNote/`,
                witness: {% if site_request %}`${window.location.protocol}//${window.location.host}/witnesses/${window.nvs.play}/`{% else %}`${window.nvs.corporaHost}/api/corpus/${window.nvs.corpusID}/nvs-witnesses/${window.nvs.play}/`{% endif %},
                witnessMeter: {% if site_request %}`/witnessmeter/`{% else %}`/nvs/witness-meter/`{% endif %},
                collationLine: `${window.nvs.corporaHost}/api/corpus/${window.nvs.corpusID}/CollationLine/`,
                differ: `${window.nvs.corporaHost}/api/corpus/${window.nvs.corpusID}/diff/${window.nvs.play}/`,
            }

            corpora.get_corpus(window.nvs.corpusID, function (corpusData) {
                window.nvs.corpus = corpusData
                add_breadcrumb(window.nvs.corpus.name, `/corpus/${window.nvs.corpusID}/`)

                fetchWitnesses(() => {
                    let grid = $('#collation-grid')

                    // find copy text lines
                    fetch(`${window.nvs.endpoints.line}?f_play.id=${window.nvs.playID}&only=xml_id,text&s_line_number=asc&page-size=10000`)
                        .then(results => results.json())
                        .then(copyTextLines => {
                            if (copyTextLines.records.length) {
                                window.nvs.copyTextEstablished = true
                                copyTextLines.records.forEach(copyTextLine => {
                                    window.nvs.lines[copyTextLine.xml_id] = {
                                        'text': copyTextLine.text,
                                    }
                                })
                            }
                            loadWitnessLines()
                        })
                    // end fetch
                })

                hide_loading_overlay()
            })
        })

        function loadWitnessLines() {
            let gridBody = $('#collation-grid-body')
            let witLineRequests = []
            let missingWits = []
            let yearSiglaMap = {}

            for (let xmlID in window.nvs.witnesses) {
                let wit = window.nvs.witnesses[xmlID]

                // associate the order of the witness with its siglum
                yearSiglaMap[wit.published] = xmlID

                // build and fire off a request to find collation lines for this witness
                witLineRequests.push(
                    fetch(`${window.nvs.endpoints.collationLine}?f_play.id=${window.nvs.playID}&f_witness.siglum=${xmlID}&only=tln&s_order=asc&page-size=10000`)
                        .then(results => results.json())
                        .then(collationLines => {
                            if (collationLines.records.length) {
                                collationLines.records.forEach(line => {
                                    if (!(line.tln in window.nvs.lines)) {
                                        window.nvs.lines[line.tln] = {
                                            'text': '',
                                        }
                                    }

                                    window.nvs.lines[line.tln][xmlID] = true
                                })
                            } else {
                                missingWits.push(xmlID)
                            }
                        })
                    // end fetch
                )
            }

            // order the witnesses by date
            window.nvs.orderedSigla = Object.keys(window.nvs.witnesses).sort((a, b) => parseInt(window.nvs.witnesses[a].published) - parseInt(window.nvs.witnesses[b].published))

            // build the witness rows
            window.nvs.orderedSigla.forEach(siglum => {
                let wit = window.nvs.witnesses[siglum]

                console.log(siglum)

                gridBody.append(`
                    <tr id="collation-grid-siglum-row-${siglum}" class="grid-row">
                        <th scope="row" class="grid-left-header">
                            <div id="collation-grid-header-${siglum}" class="d-flex w-100 flex-row justify-content-end align-items-center">
                                <span id="collation-grid-header-label-${siglum}" class="ms-auto">${wit.siglum_label}</span>
                            </div>
                        </th>
                    </tr>
                `)
                // fix labels with links in them
                let collationGridHeaderLabel = $(`#collation-grid-header-label-${siglum}`)
                collationGridHeaderLabel.html(collationGridHeaderLabel.text())

                window.nvs.witnesses[siglum]['row'] = $(`#collation-grid-siglum-row-${siglum}`)
            })

            // find the collation line tln's for each witness
            Promise.all(witLineRequests)
                .then(() => {
                    // handle sigla for which there are no lines
                    missingWits.forEach(missingWitSiglum => {
                        let witHeader = $(`#collation-grid-header-${missingWitSiglum}`)
                        witHeader.prepend(`<button id="add-lines-${missingWitSiglum}-button" class="btn btn-sm btn-primary me-2">Import</button>`)

                        let witLinesImportButton = $(`#add-lines-${missingWitSiglum}-button`)
                        let witLinesImporter = new LinesImporter(
                            window.nvs.witnesses[missingWitSiglum].document_id,
                            () => {
                                witLinesImportButton.click(() => {
                                    witLinesImporter.import()
                                })
                            }
                        )
                    })

                    // build ordered array of tlns
                    window.nvs.tlns = sortTLNs(Object.keys(window.nvs.lines))

                    // plot lines on grid
                    let startingTLN = urlParams.get('starting-tln')
                    let endingTLN = null
                    let tlnStartingIndex = 0
                    let linesPlotted = 0
                    let copyTextRow = $('#collation-grid-copy-text-row')
                    let tlnHeaderRow = $('#collation-grid-header')

                    if (window.nvs.tlns.includes(startingTLN)) tlnStartingIndex = window.nvs.tlns.indexOf(startingTLN)

                    while(linesPlotted < window.nvs.maxLines) {
                        let tln = window.nvs.tlns[tlnStartingIndex + linesPlotted]
                        let nextTLN = null
                        let text = window.nvs.lines[tln].text

                        window.nvs.visibleTLNs.push(tln)
                        if (linesPlotted === 0) startingTLN = tln

                        if (window.nvs.tlns.length > tlnStartingIndex + linesPlotted + 1) {
                            nextTLN = window.nvs.tlns[tlnStartingIndex + linesPlotted + 1]
                        }

                        tlnHeaderRow.append(`
                            <th scope="col" class="grid-col tln-header">${tln.replace('tln_', '').replace('dpln_', '')}</th>
                        `)

                        copyTextRow.append(`
                            <th id="copy-text-${tln}" scope="col" class="grid-col copy-text"><span class="play-line">${text}</span></th>
                        `)

                        for (let siglum in window.nvs.witnesses) {
                            let collationClass = 'ignore'

                            if (window.nvs.lines[tln][siglum]) collationClass = 'collate-me'

                            window.nvs.witnesses[siglum].row.append(`
                                <td id="${siglum}-${tln}"
                                    class="grid-col ${collationClass}"
                                    data-siglum="${siglum}"
                                    data-tln="${tln}"
                                    ${endingTLN !== null ? `data-prev_tln="${endingTLN}"` : ''}
                                    ${nextTLN !== null ? `data-next_tln="${nextTLN}"` : ''}>
                                        ${collationClass === 'ignore' ? '<span class="difference omission">&nbsp;</span>' : '&nbsp;'}
                                </td>
                            `)
                            window.nvs.allCells.add(`${siglum}-${tln}`)
                        }

                        linesPlotted += 1
                        if (tlnStartingIndex + linesPlotted === window.nvs.tlns.length) linesPlotted = window.nvs.maxLines
                        endingTLN = tln
                    }

                    lineCollator = new LineCollator()
                    controlPanel = new ControlPanel(startingTLN, endingTLN)
                    $(document).on('click', '.difference', function() {
                        let diff = $(this)
                        if (!diff.hasClass('omission')) {
                            if (diff.hasClass('selected')) diff.removeClass('selected')
                            else diff.addClass('selected')
                        }
                    })
                    $(document).on('keydown', function(event) {
                        if (event.shiftKey) {
                            if (event.key === 'Backspace' || event.key === 'Delete') {
                                deleteDiffSpans()
                            } else if (event.key === 'Escape') {
                                $('.difference.selected').each(function() {
                                    $(this).removeClass('selected')
                                })
                            }
                        }
                    })

                    $('.collate-me').dblclick(function() {
                        controlPanel.editLine($(this))
                    })

                    if (editedSiglum && editedTLN) {
                        setTimeout(() => {
                            let editedCell = document.getElementById(`${editedSiglum}-${editedTLN}`)
                            editedCell.scrollIntoView()
                            editedCell.classList.add('editing')
                            setTimeout(() => scrollToCell(editedCell), 2000)
                        }, 2000)
                    }
                })
            // end promise
        }

        function deleteDiffSpans() {
            $('.difference.selected').each(function() {
                let text = $(this).text()
                $(this).replaceWith(text)
            })
        }

        function scrollToCell(cell) {
            let stickyHeader = $('#collation-grid-topmost')
            let stickyColumn = $('#collation-grid-leftmost')
            let headerHeight = stickyColumn[0].offsetHeight + (stickyHeader[0].offsetHeight * 2)
            let columnWidth = stickyColumn[0].offsetWidth * 2
            let rect = cell.getBoundingClientRect()
            let container = $('#collation-grid-container')
            let scrollTop = container[0].scrollTop + rect.top - (headerHeight)
            let scrollLeft = container[0].scrollLeft + rect.left - (columnWidth)

            container[0].scrollTo({
                top: scrollTop,
                left: scrollLeft,
                behavior: 'smooth'
            })

        }
    </script>
{% endblock %}