{% extends 'nvs_base.html' %}
{% load static %}

{% block headrefs %}
<link href="{% static 'css/fontawesome.min.css' %}" rel="stylesheet">
<link href="{% static 'css/regular.min.css' %}" rel="stylesheet">
<link href="{% static 'css/solid.min.css' %}" rel="stylesheet">
<style>
    :root {
        --sideBar: 400px;
        --nvs-background-color: #FFFFFF;
        --nvs-lightest-gray: #F2F2F2;
        --nvs-light-gray: #E6E6E6;
        --nvs-lighter-gray: #cfcfcf;
        --nvs-mid-gray: #828282;
        --nvs-yellow-gray: #3b371c;
        --nvs-dark-blue: #2a69a1;
        --nvs-light-blue: #6c9ecc;
        --nvs-lightest-blue: rgb(235, 244, 252);
        --nvs-primary-orange: #CC5F38;
        --nvs-secondary-orange: #F1B06E;
        --nvs-burnt-orange: #d87448;
        --nvs-light-orange: #F9EFE4;
        --nvs-dark-yellow: #F0E438;
        --nvs-light-yellow: #f9f1d9;
        --nvs-light-beige: #FBF5F1;
        --nvs-dark-beige: #EBE4DD;
    }

    html {
        scroll-padding-top: 80px;
    }

    .anchor:before {
        content: unset;
        display: unset;
        padding-top: unset;
        margin-top: unset;
    }

    .modal-opening {
        overflow: hidden;
    }

    .paratext {
        font-family: "Halyard Text", sans-serif;
    }
    .paratext h1,
    .paratext h2,
    .paratext h3,
    .paratext h4,
    .paratext h5,
    .paratext h6 {
        font-weight: 500;
        margin-top: 10px;
        margin-bottom: 10px;
        /*line-height: 22px;*/
    }
    .paratext h1 {
        font-family: "Halyard Text", sans-serif;
        font-size: 24px;
        text-transform: none;
        color: red;
        letter-spacing: 0;
    }
    .paratext h2 {
        font-size: 22px;
        margin-top: 40px;
    }
    .paratext h3 {
        font-size: 20px;
        margin-top: 40px;
    }
    /*Stop the title at the top of the page from getting the margin top*/
    .paratext h2:nth-child(2),
    .paratext h3:nth-child(2) {
        margin-top: 0;
    }

    .paratext h4,
    .paratext .large {
        font-size: 18px;
    }
    .paratext h5,
    .paratext h6,
    .paratext p {
        font-size: 16px;
    }

    h2.level-1 {
        font-size: 24pt;
    }

    .paratext p {
        margin-top: 10px;
        margin-bottom: 10px;
        text-align: left;
        hyphens: auto;
        line-height: 22px;
    }
    .paratext .justify {
        text-align: justify;
    }
    .paratext table {
        font-size: 15px;
        margin: 5px 40px;
        line-height: 2;
    }
    .paratext td {
        vertical-align: top;
        padding: 5px;
    }

    .pt_textual_note {
        margin: 10px 0 10px 30px;
        font-size: 15px;
        line-height: 20px;
        display: flex;
        flex-direction: row;
    }
    .pt_textual_note > .ref-lb:first-child {
        flex: 0 0 120px;
        padding-right: 15px;
    }
    .pt_textual_note > .apparatus:first-child {
        margin-left: 120px;
    }
    .apparatus .under-caret {
        font-size: 24px;
    }

    .ref-lb,
    .ref {
        color: var(--blue);
        text-decoration: underline;
        font-family: "Roboto Condensed", sans-serif;
        font-weight: 700;
        cursor: pointer;
    }
    .ref-bibl {
        color: var(--blue);
        text-decoration: underline;
        font-weight: 700;
        cursor: pointer;
    }
    .ref-siglum {
        color: var(--orange);
        text-decoration: underline;
        font-weight: 700;
        font-variant-numeric: normal;
        /*font-size: 14px;*/
        cursor: pointer;
    }
    .witness-list {
        margin: 20px 0;
    }

    .witness {
        margin: 10px 0 10px 10px;
        display: grid;
        grid-template-columns: 1fr 4fr 1fr;
        align-items: start;
        grid-gap: 5px;
        font-size: 15px;
        line-height: 22px;
    }
    @media ( min-width: 992px ) {
        .witness {
            margin-left: 40px;
            grid-template-columns: 80px 4fr 80px;
            grid-gap: 10px;
        }
    }
    .witness .ref-siglum {
        text-decoration: none;
    }

    .name {
        text-transform: capitalize;
    }
    .name, .author, .editor, .note-toggler {
        color: var(--blue);
        font-weight: 700;
    }

    .note-toggler {
        cursor: pointer;
        font-weight: unset;
        margin-left: 3px;
        margin-right: 3px;
    }

    .tooltip {
        background-color: white;
        border: solid 1px var(--blue);
        padding: 10px;
        max-width: 500px;
        z-index: 1000;
    }
    .tooltip-inner { background-color: white; }

    .date {
        font-weight: 700;
    }

    .title.level_m, .title.level_j {
        font-style: italic;
    }
    .title.level_m .title.level_m {
        font-style: normal;
    }

    .title.level_a {
        quotes: "“" "”" "‘" "’";
    }
    .title.level_a::before {
        content: open-quote;
    }
    .title.level_a::after {
        content: close-quote;
    }

    .quote {
        quotes: "‘" "’";
    }
    .quote::before {
        content: open-quote;
    }
    .quote::after {
        content: close-quote;
    }

    .bibl-list {
        margin: 20px 0;
    }

    .bibl {
        margin: 10px 0 10px 40px;
        font-size: 15px;
        line-height: 22px;
        display: block;
        text-indent: -1em;
    }

    .witness .bibl {
        margin: 0;
    }

    .paratext ul {
        list-style: none;
        padding-left: 40px;
        margin: 10px 0;
    }
    .paratext li {
        margin: 10px 0;
    }
    dt, dd {
        display: inline-block;
        margin: 0;
    }
    .paratext li > dt:first-child {
      min-width: 100px;
    }

    .speech {
        margin-left: 280px;
    }

    .speech .type-source {
        margin-left: -280px;
        width: 280px;
        padding-right: 20px;
        display: inline-block;
    }

    .speaker {
        font-style: italic;
    }
    .figure {
        margin-left: 40px;
    }

    q.rend-block {
        quotes: none;
        display: block;
        margin: 10px 0 10px 40px;
    }
    q.rend-no_qmarks:before { display: none; }
    q.rend-no_qmarks:after { display: none; }

    /* Rend styles */
    .rend-indent1em { margin-left: 10px; }
    .rend-indent2em { margin-left: 20px; }
    .rend-indent7em { margin-left: 70px; }
    .rend-indent8em { margin-left: 80px; }
    .rend-indent10em { margin-left: 100px; }
    .rend-indent15em { margin-left: 150px; }
    .rend-italic { font-style: italic; }
    .rend-bold { font-weight: 700; }
    .rend-aligncenter, .rend-aligncenter p { text-align: center !important; }
    .rend-alignleft, .rend-alignleft p { text-align: left !important; }
    .rend-alignright, .rend-alignright p { text-align: right !important; }
    .rend-allcaps { text-transform: uppercase; }
    .rend_smcaps, .rend-smcaps, .siglum { font-variant: small-caps; font-weight: bold; }

    .type-marginalia.nvs-seg, .note-margin {
        float: right;
    }

    .floating-text,
    .floating-text h3,
    .floating-text h4,
    .floating-text h5,
    .floating-text h6,
    .floating-text p {
        font-size: 15px;
        line-height: 20px;
    }
    .floating-text .type-main,
    .floating-text .type-sub {
        font-size: 16px;
        font-weight: bold;
    }
    .floating-text {
        margin: 0 40px 80px 40px;
    }
    .floating-text p {
        text-align: justify;
    }

    .paratext ul.type-ordered {
        margin-top: 20px;
        margin-bottom: 20px;
        padding-left: 60px;
    }
    .paratext ul.type-ordered li {
        padding-left: 60px;
        position: relative;
    }
    .paratext ul.type-ordered li .label {
        position: absolute;
        top: 0;
        left: 0;
    }

    p.digital-nvs-comment {
        padding: 10px;
        background-color: #EBF4FC;
    }

    /* -----------------------------
    || STYLES IMPORTED FROM PLAYVIEWER TO SUPPORT REF MODALS
    || -------------------------- */

    @font-face {
        font-family: "HalyardTextBook";
        src: url("/static/proprietary/font/HalyardTextBook.woff2") format('woff2'), url("/static/proprietary/font/HalyardTextBook.woff") format('woff');
    }

    @font-face {
        font-family: "HalyardTextSemiBold";
        src: url("/static/proprietary/font/HalyardTextSemBd.woff2") format('woff2'), url("/static/proprietary/font/HalyardTextSemBd.woff") format('woff');
    }

    @font-face {
        font-family: "HalyardTextMedium";
        src: url("/static/proprietary/font/HalyardTextMed.woff2") format('woff2'), url("/static/proprietary/font/HalyardTextMed.woff") format('woff');
    }

    @font-face {
        font-family: "Baskerville";
        src: url("/static/proprietary/font/Baskerville10Pro.woff") format('woff');
    }

    @font-face {
        font-family: "Baskerville";
        src: url("/static/proprietary/font/Baskerville10Pro-Bold.woff") format('woff');
        font-weight: bold;
    }

    @font-face {
        font-family: "Baskerville";
        src: url("/static/proprietary/font/Baskerville10Pro-Italic.woff") format('woff');
        font-style: italic;
    }

    @font-face {
        font-family: "Baskerville";
        src: url("/static/proprietary/font/Baskerville10Pro-BoldItalic.woff") format('woff');
        font-weight: bold;
        font-style: italic;
    }

    .d-flex {
        display: flex !important;
    }

    .justify-content-between {
        -webkit-box-pack: justify!important;
        -ms-flex-pack: justify!important;
        justify-content: space-between!important;
    }

    .justify-content-center {
        -webkit-box-pack: center!important;
        -ms-flex-pack: center!important;
        justify-content: center!important;
    }

    .row {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -ms-flex-wrap: wrap;
        flex-wrap: wrap;
        margin-right: -15px;
        margin-left: -15px;
    }

    .no-gutters, .gx-0 {
        margin-right: 0;
        margin-left: 0;
    }

    .p-0 {
        padding: 0!important;
    }
    .m-0 {
        margin: 0!important;
    }

    .w-100 {
        width: 100%!important;
    }

    .col-sm-10 {
        position: relative;
        width: 100%;
        min-height: 1px;
        -webkit-box-flex: 0;
        -ms-flex: 0 0 83.333333%;
        flex: 0 0 83.333333%;
        max-width: 83.333333%;
    }

    .col-sm-1 {
        -webkit-box-flex: 0;
        -ms-flex: 0 0 8.333333%;
        flex: 0 0 8.333333%;
        max-width: 8.333333%;
    }

    /********************/
    /* REF MODAL STYLES */
    /********************/

    #nav-modal-label {
        font-family: 'Baskerville', serif;
        font-variant-numeric: oldstyle-nums;
    }

    #nav-modal-body {
        font-family: 'FormulaSerial';
        overflow-y: scroll;
        max-height: calc(80vh);
    }

    .ref-modal {
        position: absolute;
        max-width: calc(40vw);
        z-index: 500;
    }

    .ref-modal .tab-pane {
        padding: 10px;
    }

    .arrow-right, .arrow-left, .arrow-top, .arrow-none {
        background-color: #FFFFFF;
        position: relative;
        box-sizing: border-box;
        border: 1px solid var(--nvs-mid-gray);
        box-shadow: 0px 3px 3px 0 rgba(0, 0, 0, 0.4);
    }

    .arrow-right {
        float: left;
    }

    .arrow-left {
        float: right;
    }

    .arrow-right:after, .arrow-right:before, .arrow-left:after, .arrow-left:before, .arrow-top:after, .arrow-top:before {
        content: " ";
        width: 0;
        height: 0;
        position: absolute;
        left: -15px;
        top: 10%;
    }

    .arrow-right:after, .arrow-right:before {
        left: 100%;
    }

    .arrow-top:after, .arrow-top:before {
        top: -15px;
        left: 15px;
    }

    .arrow-right:after {
        border-top: 15px solid transparent;
        border-right: none;
        border-left: 15px solid white;
        border-bottom: 15px solid transparent;
    }

    .arrow-right:before {
        border-top: 17px solid transparent;
        border-right: none;
        border-left: 16px solid var(--nvs-mid-gray);
        border-bottom: 16px solid transparent;
        margin-top: -2px;
    }

    .arrow-left:after {
        border-top: 15px solid transparent;
        border-left: none;
        border-right: 15px solid white;
        border-bottom: 15px solid transparent;
    }

    .arrow-left:before {
        border-top: 17px solid transparent;
        border-left: none;
        border-right: 16px solid var(--nvs-mid-gray);
        border-bottom: 16px solid transparent;
        margin-top: -2px;
        margin-left: -1px;
    }

    .arrow-top:after {
        border-top: none;
        border-right: 15px solid transparent;
        border-left: 15px solid transparent;
        border-bottom: 15px solid white;
        margin-left: 1px;
    }

    .arrow-top:before {
        border-top: none;
        border-right: 16px solid transparent;
        border-left: 16px solid transparent;
        border-bottom: 16px solid var(--nvs-mid-gray);
        top: -16px;
    }

    .ref-modal-header {
        font-family: 'Roboto Condensed', sans-serif;
        font-weight: bold;
        text-transform: uppercase;
        color: #000000;
        padding: 10px;
        cursor: move;
    }

    .ref-subtitle-marker {
        background-color: var(--nvs-dark-blue);
        width: 13px;
        height: 13px;
        display: inline-block;
        margin-right: 3px;
        position: relative;
        top: 5px;
    }

    .ref-modal-control {
        cursor: pointer;
        height: 20px;
        width: 20px;
        display: inline-block;
        margin-left: 5px;
        text-decoration: none;
        color: var(--nvs-mid-gray);
    }

    .ref-modal-control:hover {
        text-decoration: none;
    }

    .ref-modal-control.new-tab {
        background-image: url('/static/img/controls/Modal-NEWTAB.svg');
    }

    .ref-modal-control.new-tab:hover {
        background-image: url('/static/img/controls/Modal-NEWTAB-all-ROLL.svg');
    }

    .ref-modal-control.go-to {
        background-image: url('/static/img/controls/Modal-GOTO.svg');
    }

    .ref-modal-control.go-to:hover {
        background-image: url('/static/img/controls/Modal-GOTO-ALL-ROLL.svg');
    }

    .ref-modal-control.close {
        background-image: url('/static/img/controls/Modal-CLOSE.svg');
    }

    .ref-modal-control.close:hover {
        background-image: url('/static/img/controls/Modal-CLOSE-all-ROLL.svg');
    }

    .ref-modal-content {
        padding: 10px;
        font-family: 'HalyardTextBook';
        max-height: calc(40vh);
        overflow-y: scroll;
        overscroll-behavior: contain;
    }

    .ref-modal-content .comm-heading {
        cursor: unset;
    }

    .ref-modal-content .comm-heading:hover {
        color: #000000;
    }

    .ref-row {
        width: calc(40vw);
        border-top: solid 1px var(--nvs-lighter-gray);
    }

    .ref-row:last-child {
        border-bottom: solid 1px var(--nvs-lighter-gray);
    }

    /*
    .ref-modal {
        position: absolute;
        max-width: calc(40vw);
        z-index: 500;
    }

    .arrow-right, .arrow-left {
        background-color: #FFFFFF;
        position: relative;
        box-sizing: border-box;
        border: 1px solid #828282;
        box-shadow: 0px 3px 3px 0 rgba(0, 0, 0, 0.4);
    }

    .arrow-right {
        float: left;
    }

    .arrow-left {
        float: right;
    }

    .arrow-right:after, .arrow-right:before, .arrow-left:after, .arrow-left:before {
        content: " ";
        width: 0;
        height: 0;
        position: absolute;
        left: -15px;
        top: 10%;
    }

    .arrow-right:after, .arrow-right:before {
        left: 100%;
    }

    .arrow-right:after {
        border-top: 15px solid transparent;
        border-right: none;
        border-left: 15px solid white;
        border-bottom: 15px solid transparent;
    }

    .arrow-right:before {
        border-top: 17px solid transparent;
        border-right: none;
        border-left: 16px solid #828282;
        border-bottom: 16px solid transparent;
        margin-top: -2px;
    }

    .arrow-left:after {
        border-top: 15px solid transparent;
        border-left: none;
        border-right: 15px solid white;
        border-bottom: 15px solid transparent;
    }

    .arrow-left:before {
        border-top: 17px solid transparent;
        border-left: none;
        border-right: 16px solid #828282;
        border-bottom: 16px solid transparent;
        margin-top: -2px;
        margin-left: -1px;
    }

    .ref-modal-header {
        font-family: 'Roboto Condensed', sans-serif;
        font-weight: bold;
        text-transform: uppercase;
        color: #000000;
        padding: 10px;
        cursor: move;
    }

    .ref-subtitle-marker {
        background-color: #2a69a1;
        width: 13px;
        height: 13px;
        display: inline-block;
        margin-right: 3px;
        position: relative;
        top: 5px;
    }

    .ref-modal-control {
        cursor: pointer;
        height: 20px;
        margin-left: 5px;
    }

    .ref-modal-control.close {
        background-image: url('/static/img/controls/Modal-CLOSE.svg');
    }

    .ref-modal-content {
        padding: 10px;
        font-family: 'HalyardTextBook';
        max-height: calc(40vh);
        overflow-y: scroll;
        overscroll-behavior: contain;
    }

    .ref-modal-content a.anchor[name] {
        display: inline-block;
        scroll-margin-top: 20px;
    }

    .ref-modal-content .anchor[name]:before {
        padding-top: 0;
        margin-top: 0;
    }

    .ref-row {
        width: calc(40vw);
        border-top: solid 1px #cfcfcf;
    }

    .ref-row:last-child {
        border-bottom: solid 1px #cfcfcf;
    }
    */

    .play-words {
        padding-top: 10px;
        padding-bottom: 5px;
        padding-left: 0px;
        font-family: 'Baskerville', serif;
        font-variant-numeric: oldstyle-nums;
        font-size: clamp(1.125rem, 1.2vw, 1.5rem);
        color: #070707;
        background-color: white;
        -webkit-box-align: center!important;
        -ms-flex-align: center!important;
        align-items: center!important;
        display: -webkit-box!important;
        display: -ms-flexbox!important;
        display: flex!important;
    }

    .play-label {
        background-color: white;
        color: #828282;
        border: none;
        border-left: solid 1px #cfcfcf;
        border-right: solid 1px #cfcfcf;
        font-family: 'Roboto Condensed', sans-serif;
        font-size: 12px;
        -webkit-box-align: center!important;
        -ms-flex-align: center!important;
        align-items: center!important;
        display: -webkit-box!important;
        display: -ms-flexbox!important;
    }

    .actscene-indicator {
        color: #828282;
        font-size: 12px;
        cursor: pointer;
        background-color: #F2F2F2;
        -webkit-box-align: center!important;
        -ms-flex-align: center!important;
        align-items: center!important;
        display: -webkit-box!important;
        display: -ms-flexbox!important;
    }

    .comm-heading {
        background-color: #F0E438;
        font-family: 'Baskerville', serif;
        font-variant-numeric: oldstyle-nums;
        cursor: pointer;
        color: #000000;
    }

    .comm-block {
        color: #000000;
        font-family: 'HalyardTextBook';
        font-size: clamp(13px,1.2vw,16px);
        margin-bottom: 20px;
        font-variant-numeric: oldstyle-nums;
    }

    .comm-block a {
        color: #2a69a1;
    }

    .graphic {
        display: block;
        width: 90%;
        margin-left: auto;
        margin-right: auto;
    }
</style>

{% endblock %}

{% block main %}

<div class="page-title">
  <h1 class="edition-header">
    {{ play.title }} {% include 'svg/arrow.svg' %} <span class="edition-header--title">{{ section }}</span>
  </h1>
</div>

<div class="page-holder is-white">
  <div class="container">
    <div class="page-holder--inner has-max-width">
      <div class="anchor-links--holder">
        <button class="anchor-links--toggle link roboto-uppercase">page navigation</button>
        <ul class="anchor-links--inner">
            {{ toc|safe }}
        </ul>
      </div>
      <div>
        <div class="paratext">
            {{ html|safe }}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
<script src="{% static 'js/jquery-3.3.1.min.js' %}"></script>
<script src="{% static 'js/popper.min.js' %}"></script>
<script src="{% static 'js/bootstrap.min.js' %}"></script>
<!--<script src="{% static 'js/corpora.js' %}"></script>-->
<script src="{% static 'js/utilities.js' %}"></script>
<script type="application/javascript">
    /*
    let corpora;
    let corpus_id = "{{ corpus_id }}"
    let corpora_url = "{{ corpora_url }}"
    let play_prefix = "{{ play.prefix }}"
    let play_id = "{{ play.id }}"
    let playviewer_url = {% if site_request %}`/edition/${play_prefix}/`{% else %}`/corpus/${corpus_id}/play-viewer/${play_prefix}/`{% endif %}
    let paratext_prefix = {% if site_request %}''{% else %}`/corpus/${corpus_id}/paratext-viewer/${play_prefix}/`{% endif %}
    let lines_endpoint = {% if site_request %}`${window.location.protocol}//${window.location.host}/lines/${play_prefix}/`{% else %}`/api/corpus/${corpus_id}/nvs-lines/${play_prefix}/`{% endif %}
    let ref_modal_counter = 0

    let nav_map = {
        'lb': {
            'content_type': 'PlayLine',
            'xml_id_field': 'xml_id',
            'content_field': 'rendered_html',
            'title': 'LINE',
            'title_plural': 'LINES',
            'scroll_anchor': false,
            'filter_play': true,
        },
        'bibl': {
            'content_type': 'Reference',
            'xml_id_field': 'document.siglum',
            'content_field': 'bibliographic_entry',
            'title': "BIBLIOGRAPHY",
            'title_plural': "BIBLIOGRAPHY",
            'scroll_anchor': false,
            'filter_play': false,
        },
        'siglum': {
            'content_type': 'Reference',
            'xml_id_field': 'document.siglum',
            'content_field': 'bibliographic_entry',
            'title': "COLLATED EDITION",
            'title_plural': "COLLATED EDITIONS",
            'scroll_anchor': false,
            'filter_play': false,
        },
        'note_cn': {
            'content_type': 'Commentary',
            'xml_id_field': 'xml_id',
            'content_field': 'contents',
            'title': "COMMENTARY",
            'title_plural': "COMMENTARY",
            'scroll_anchor': false,
            'filter_play': true,
        },
        'div': {
            'content_type': 'ParaText',
            'xml_id_field': 'xml_id',
            'content_field': 'html_content',
            'title': "APPENDIX",
            'title_plural': "APPENDIX",
            'scroll_anchor': true,
            'filter_play': true,
        },
        'anchor': {
            'content_type': 'ParaText',
            'xml_id_field': 'child_xml_ids',
            'content_field': 'html_content',
            'title': "APPENDIX",
            'title_plural': "APPENDIX",
            'scroll_anchor': true,
            'filter_play': true,
        }
    };*/

    window.nvs = {
        corporaHost: '{{ corpora_host }}',
        corpusID: '{{ corpus_id }}',
        play: '{{ play.prefix }}',
        playViewer: null,
        playViewerURL: {% if site_request %}`/edition/{{ play.prefix }}/`{% else %}`/corpus/{{ corpus_id }}/play-viewer/{{ play.prefix }}/`{% endif %},
        paratextPrefix: {% if site_request %}''{% else %}`/corpus/{{ corpus_id }}/paratext-viewer/{{ play.prefix }}/`{% endif %},
        staticPath: '/static',
        witnesses: null,
        witnessCount: null,
        witnessCenturies: null
    }
    window.nvs.endpoints = {
        line: `${window.nvs.corporaHost}/api/corpus/${window.nvs.corpusID}/PlayLine/`,
        lineRange: {% if site_request %}`${window.location.protocol}//${window.location.host}/lines/${window.nvs.play}/`{% else %}`/api/corpus/${window.nvs.corpusID}/nvs-lines/${window.nvs.play}/`{% endif %},
        commentary: `${window.nvs.corporaHost}/api/corpus/${window.nvs.corpusID}/Commentary/`,
        note: `${window.nvs.corporaHost}/api/corpus/${window.nvs.corpusID}/TextualNote/`,
        search: {% if site_request %}`${window.location.protocol}//${window.location.host}/search/${window.nvs.play}/`{% else %}`/api/corpus/${window.nvs.corpusID}/nvs-search/${window.nvs.play}/`{% endif %},
        speech: `${window.nvs.corporaHost}/api/corpus/${window.nvs.corpusID}/Speech/`,
        witness: {% if site_request %}`${window.location.protocol}//${window.location.host}/witnesses/${window.nvs.play}/`{% else %}`${window.nvs.corporaHost}/api/corpus/${window.nvs.corpusID}/nvs-witnesses/${window.nvs.play}/`{% endif %},
        witnessMeter: {% if site_request %}`/witnessmeter/`{% else %}`/nvs/witness-meter/`{% endif %},
        minimap: {% if site_request %}`/minimap/${window.nvs.play}/`{% else %}`/corpus/${window.nvs.corpusID}/play-minimap/${window.nvs.play}/`{% endif %}
    }

    $(document).ready(function() {
        //corpora = new Corpora({'csrf_token': "{{ csrf_token }}"{% if site_request %},'host': '{{ corpora_url }}'{% endif %}});

        // Place statement about digital edition of NVS before textual note section
        let textual_note_explanation = $('#textual_note_explanation_start');
        if (textual_note_explanation.length) {
            textual_note_explanation.prepend(`
                <p class="digital-nvs-comment">
                    <b>Note</b>: In the section below you will find the original explanation for reading textual notes
                    as they appear throughout the
                    <a href="{% if site_request %}/print-editions/{% else %}/corpus/{{ corpus_id }}/print/{% endif %}" target="_blank">print edition</a>
                    of this volume. For the present, digital edition of this
                    volume, textual notes for the play text have been re-envisioned so as to provide a line-by-line,
                    aggregated view of change over time throughout collated editions (or witnesses) in the form of a
                    histogram. These visualizations can be expanded to show how the variant line appears in given
                    witnesses. For more information about how to read textual notes in the digital version of this
                    volume, watch our
                    <a href="{% if site_request %}/how-to/{% else %}/corpus/{{ corpus_id }}/how-to/{% endif %}#textual-notes-search" target="_blank">video tutorial</a>.
                    The original, print convention for textual notes is still used, however, in the
                    <a href="{% if site_request %}/appendix/${play_prefix}/{% else %}/corpus/{{ corpus_id }}/paratext-viewer/${play_prefix}/Appendix/{% endif %}" target="_blank">Appendix</a>
                    of this digital edition, particularly in the "Irregular, Doubtful, and Emended Accidentals" and
                    "Unadopted Conjectures" sections.
                </p>
            `);
        }

        // Add credit to the MLA at end of Credits section
        let section_headers = $('h2.level-1');
        let found_credits = false;
        section_headers.each(function() {
            let header = $(this);
            if (header.html() === 'Credits') found_credits = true;
            else if (found_credits) {
                let notice = document.createElement('p');
                notice.innerHTML = `With founding sponsorship from the Modern Language Association of America, exclusive publisher of the NVS, 1936-2019.`;
                $(notice).insertBefore(header);
                found_credits = false;
            }
        });

        $('img.graphic').each(function() {
            let graphic = $(this);
            let repo_name = graphic.data('repo-name');
            let path = graphic.data('path');
            let src = `${window.nvs.corporaHost}/repo-file/${window.nvs.corpusID}/${repo_name}/?path=${path}`;
            graphic.attr('src', src);
        });

        $('.author.display_bookldash').each(function() {
            let span = $(this);
            span.html(`&mdash;&mdash;${span.html().endsWith('.') ? '.' : ''}`);
        });

        // attempt to address marginal notes problem via tooltips
        let margin_notes = $('.type-source.note-margin')
        margin_notes.each(function() {
            let note_html = this.outerHTML.replaceAll('-<br><br>', '').replaceAll('<br><br>', ' ')
            let note = $(this)
            let note_toggler = $(`
                <span class="note-toggler far fa-sticky-note"
                    data-toggle="tooltip"
                    data-html="true"
                    data-placement="top">
                </span>
            `)
            note_toggler.attr('title', note_html)
            note.after(note_toggler)
            note.remove()
        })
        $('.note-toggler').tooltip()

        // fix problem where under-caret too small inside textual notes
        $('.pt_textual_note .apparatus').each(function() {
            let app = $(this)
            app.html(app.html().replaceAll('‸', '<span class="under-caret">‸</span>'))
        })
    })
</script>
{% endblock %}